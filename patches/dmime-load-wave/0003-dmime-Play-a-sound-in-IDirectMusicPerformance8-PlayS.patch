From b9c561a99b7034e3cac64ab85e4d50a6fb0c304c Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Mon, 12 Dec 2022 15:20:10 +1100
Subject: [PATCH] dmime: Play a sound in IDirectMusicPerformance8 PlaySegmentEx

---
 dlls/dmime/dmime_private.h | 1 +
 dlls/dmime/performance.c   | 6 ++++++
 dlls/dmime/segment.c       | 6 ++++++
 3 files changed, 13 insertions(+)

diff --git a/dlls/dmime/dmime_private.h b/dlls/dmime/dmime_private.h
index ca8323fc525..2b4537233fc 100644
--- a/dlls/dmime/dmime_private.h
+++ b/dlls/dmime/dmime_private.h
@@ -73,6 +73,7 @@ extern void set_audiopath_primary_dsound_buffer(IDirectMusicAudioPath*,IDirectSo
 extern HRESULT segment_state_create(IDirectMusicSegment *segment, MUSIC_TIME start_time,
         IDirectMusicSegmentState **ret_iface);
 extern IDirectSound *get_dsound_interface(IDirectMusicPerformance8*);
+extern IDirectSoundBuffer *get_segment_buffer(IDirectMusicSegment8 *iface);
 
 /*****************************************************************************
  * Auxiliary definitions
diff --git a/dlls/dmime/performance.c b/dlls/dmime/performance.c
index 3658c16c187..14831e72ba3 100644
--- a/dlls/dmime/performance.c
+++ b/dlls/dmime/performance.c
@@ -1078,6 +1078,7 @@ static HRESULT WINAPI performance_PlaySegmentEx(IDirectMusicPerformance8 *iface,
     IDirectMusicSegmentState *state;
     IDirectMusicSegment *segment;
     HRESULT hr;
+    IDirectSoundBuffer *buffer;
 
     FIXME("(%p, %p, %s, %p, %#lx, %I64d, %p, %p, %p): stub\n", This, source, debugstr_w(segment_name),
             transition, segment_flags, start_time, segment_state, from, audio_path);
@@ -1096,6 +1097,11 @@ static HRESULT WINAPI performance_PlaySegmentEx(IDirectMusicPerformance8 *iface,
         IDirectMusicSegmentState_AddRef(state);
     }
 
+    buffer = get_segment_buffer(segment);
+
+    if (segment)
+        hr = IDirectSoundBuffer_Play(buffer, 0, 0, 0);
+
     IDirectMusicSegmentState_Release(state);
     IDirectMusicSegment_Release(segment);
     return hr;
diff --git a/dlls/dmime/segment.c b/dlls/dmime/segment.c
index 284564749df..af76258c979 100644
--- a/dlls/dmime/segment.c
+++ b/dlls/dmime/segment.c
@@ -64,6 +64,12 @@ static inline struct segment *impl_from_IDirectMusicSegment8(IDirectMusicSegment
     return CONTAINING_RECORD(iface, struct segment, IDirectMusicSegment8_iface);
 }
 
+IDirectSoundBuffer *get_segment_buffer(IDirectMusicSegment8 *iface)
+{
+    struct segment *This = impl_from_IDirectMusicSegment8(iface);
+    return This->buffer;
+}
+
 static HRESULT WINAPI segment_QueryInterface(IDirectMusicSegment8 *iface, REFIID riid, void **ret_iface)
 {
     struct segment *This = impl_from_IDirectMusicSegment8(iface);
-- 
2.42.0


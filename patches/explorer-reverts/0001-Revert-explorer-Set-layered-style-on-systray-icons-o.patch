From 3121022dbf17c32503ed18be302c0cee219b394c Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Sat, 10 Feb 2024 13:06:22 +1100
Subject: [PATCH 1/2] Revert "explorer: Set layered style on systray icons only
 when it's actually layered."

This reverts commit b5c57b9a62c396068d18237bd6e82b37c169fdc5.
---
 programs/explorer/systray.c | 4 +---
 1 file changed, 1 insertion(+), 3 deletions(-)

diff --git a/programs/explorer/systray.c b/programs/explorer/systray.c
index c76ebdd0c92..74e5c3b6b48 100644
--- a/programs/explorer/systray.c
+++ b/programs/explorer/systray.c
@@ -624,7 +624,6 @@ static BOOL show_icon(struct icon *icon)
     {
         icon->display = ICON_DISPLAY_DOCKED;
         icon->layered = TRUE;
-        SetWindowLongW( icon->window, GWL_EXSTYLE, GetWindowLongW( icon->window, GWL_EXSTYLE ) | WS_EX_LAYERED );
         SendMessageW( icon->window, WM_SIZE, SIZE_RESTORED, MAKELONG( icon_cx, icon_cy ) );
     }
     systray_add_icon( icon );
@@ -646,7 +645,6 @@ static BOOL hide_icon(struct icon *icon)
     {
         icon->display = ICON_DISPLAY_HIDDEN;
         icon->layered = FALSE;
-        SetWindowLongW( icon->window, GWL_EXSTYLE, GetWindowLongW( icon->window, GWL_EXSTYLE ) & ~WS_EX_LAYERED );
     }
     ShowWindow( icon->window, SW_HIDE );
     systray_remove_icon( icon );
@@ -734,7 +732,7 @@ static BOOL add_icon(NOTIFYICONDATAW *nid)
     icon->owner  = nid->hWnd;
     icon->display = ICON_DISPLAY_HIDDEN;
 
-    CreateWindowExW( 0, tray_icon_class.lpszClassName, NULL, WS_CLIPSIBLINGS | WS_POPUP,
+    CreateWindowExW( WS_EX_LAYERED, tray_icon_class.lpszClassName, NULL, WS_CLIPSIBLINGS | WS_POPUP,
                      0, 0, icon_cx, icon_cy, 0, NULL, NULL, icon );
     if (!icon->window) ERR( "Failed to create systray icon window\n" );
 
-- 
2.43.0


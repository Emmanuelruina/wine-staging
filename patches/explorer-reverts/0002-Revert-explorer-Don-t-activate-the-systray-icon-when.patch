From 57bf893be6bae301dbc1099615096d2f3644119b Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Sat, 10 Feb 2024 13:06:23 +1100
Subject: [PATCH 2/2] Revert "explorer: Don't activate the systray icon when
 showing it."

This reverts commit 5e7a8f4db045d456913f9bd7075191ad14053375.
---
 programs/explorer/systray.c | 11 +----------
 1 file changed, 1 insertion(+), 10 deletions(-)

diff --git a/programs/explorer/systray.c b/programs/explorer/systray.c
index 74e5c3b6b48..43187db30b5 100644
--- a/programs/explorer/systray.c
+++ b/programs/explorer/systray.c
@@ -543,15 +543,6 @@ static LRESULT WINAPI tray_icon_wndproc( HWND hwnd, UINT msg, WPARAM wparam, LPA
         break;
     }
 
-    case WM_WINDOWPOSCHANGING:
-        if (icon->display == ICON_DISPLAY_HIDDEN)
-        {
-            /* Changing the icon's parent via SetParent would activate it, stealing the focus. */
-            WINDOWPOS *wp = (WINDOWPOS*)lparam;
-            wp->flags |= SWP_NOACTIVATE;
-        }
-        break;
-
     case WM_WINDOWPOSCHANGED:
         update_systray_balloon_position();
         break;
@@ -575,9 +566,9 @@ static void systray_add_icon( struct icon *icon )
 
     if (icon->display != ICON_DISPLAY_HIDDEN) return;  /* already added */
 
+    icon->display = nb_displayed++;
     SetWindowLongW( icon->window, GWL_STYLE, GetWindowLongW( icon->window, GWL_STYLE ) | WS_CHILD );
     SetParent( icon->window, tray_window );
-    icon->display = nb_displayed++;
     pos = get_icon_pos( icon );
     SetWindowPos( icon->window, 0, pos.x, pos.y, 0, 0, SWP_NOSIZE | SWP_NOACTIVATE | SWP_NOZORDER | SWP_SHOWWINDOW );
 
-- 
2.43.0

